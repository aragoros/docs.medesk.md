Установка службы ECR
==========================
ECR представляет собой службу Windows для работы с кассовыми аппаратами.

.. contents:: Содержание
   :depth: 3

Установка драйверов АТОЛ (только для касс АТОЛ)
--------------------------------------------

Если кассовый аппарат **НЕ АТОЛ**, то переходите к следующему шагу `Инструкция по установке службы`_.

- Скачать `драйвера <http://fs.atol.ru/_layouts/15/atol.templates/Handlers/FileHandler.ashx?guid=1703e25c-a268-41f6-a531-ffdeb9e7a120&webUrl=>`_.

- Запустите установку драйвера 

- Нажмите **Далее** |atol1|

- Принимите условия соглашения и нажмите **Далее** |atol2|

- Нажмите **Далее** |atol3|

- Нажмите **Далее** |atol4|

- Выберите тип **Полная установка** и нажмите **Далее** |atol5|

- Нажмите **Далее** |atol6|

- Дождитесь окончания установки

- Проверьте работоспособность кассы как описано в `Проверка кассы через Тест драйвер ККМ`_

- Если отправка в ОФД не настроена, то настроить как указано в `Настройка возможности отправки чеков в ОФД`_


.. ATTENTION::
   Нужно устанавливать именно эту версию драйвера (8.14.0.0). 
   Если на компьютере клиента стоит эта версия, то этот шаг можно пропустить.
   Если версия отличается, например 8.14.0.1 или 8.14.0.2, то надо установить драйвера.

Инструкция по установке службы 
--------------------------------------------

- Скачать `архив со службой <https://s3-eu-west-1.amazonaws.com/tn-releases/ecr/1.2.0.zip>`_.

- Разархивировать содержимое архива на диск C (так, чтобы получилось **C:\\EcrService**) |ecr_install1|

- Из каталога **C:\\EcrService\\ce_install** установить **SSCERuntime_x64-RUS.exe** если система 64-битная или **SSCERuntime_x86-RUS.exe** если 32-битная |ecr_install2|

- Запустить от имени администратора командную строку (**Пуск -> Все программы -> Стандартные -> Командная строка**) |ecr_install3|

- Перейти в каталог **C:\\EcrService** |ecr_install4| 

- Запустить **Install.bat** |ecr_install5|

- Дождаться окончания установки

.. ATTENTION::
    Для того чтобы установить службу из консоли  нужно набрать:
    ::

        cd C:\EcrService
        Install.bat

.. ATTENTION::
    Для работы службы нужен `.NET Framework 4.0 <https://www.microsoft.com/en-us/download/details.aspx?id=17851>`_. Если при установке службы возникает ошибка вида **“'installutil' is not recognized as an internal or external command, operable program or batch file”**, то надо установить `.NET Framework 4.0 <https://www.microsoft.com/en-us/download/details.aspx?id=17851>`_

.. ATTENTION::
    Если предполагается, что служба будут использовать с другого компьютера и если брандмауэр включен, нужно будет открыть порт этой службы как описано в `Открытие порта в брандмауэре Windows`_

Инструкция по запуску службы (только для касс АТОЛ)
--------------------------------------------

Если кассовый аппарат **НЕ АТОЛ**, то переходите к следующему шагу `Инструкция по запуску службы (общая)`_.

- Зайти в **Панель управления -> Администрирование -> Службы**. В списке служб найти **EcrService** и зайти в его **Свойства** |ecr1|

- Перейти во вкладку **Вход в систему** |ecr2|

- Выберите **С учетной записью** и нажмите **Обзор** |ecr3|

- В открывшемся окне нажмите **Дополнительно** |ecr4|

- Нажмите **Поиск** |ecr5|

- Найдите в списке аккаунт текущего пользователя, выберите его и нажмите OK |ecr6|

- Убедитесь что в **Введите имена набираемых объектов** правильный аккаунт и нажмите OK |ecr7|

- Узнайте пароль пользователя у клиента и введите их в поля **Пароль** и  **Подтверждение** и нажмите OK. Если у пользователя пароля нет, то спросите можно ли поставить пароль и поставьте пароль, например **1** |ecr8|


.. ATTENTION::
    Пароль у пользователя должен быть обязательно! Иначе без этого не запустить службу с нужными правами


Инструкция по запуску службы (общая)
--------------------------------------------

- Зайти в **Панель управления -> Администрирование -> Службы**. В списке служб найти **EcrService** и нажать **Запустить службу** |ecr9|

.. ATTENTION::
    Также можно запустить службу из консоли набрав:
    ::

        cd C:\EcrService
        StartService.bat

- Если состояние службы изменилось на **Работает**, то значит служба успешно запустилась

Известные проблемы
--------------------------------------------

Не устанавливаются **АТОЛовские драйвера**, **SSCERuntime_x64-RUS.exe** или **SSCERuntime_x86-RUS.exe**
'''''''''''''''''

**Решение.** Скорее всего у пользователя нет администраторских прав. Нужно попросить клиента чтобы предоставили пользователя с администраторскими правами

Не запускается служба. Ошибка 1067 
'''''''''''''''''
|error_2|

**Решение.** Один из возможных вариантов в том, что порт для сервиса уже занят другой программой. 

.. ATTENTION::
    Чтобы убедиться в этом можно проверить логи, как написано в `Логи службы`_ и если там есть ошибка вида **HTTP could not register URL http://+:8095/ because TCP port 8095 is being used by another application**, то значит порт занят

- По умолчанию служба запускается на порту 8095. Это можно изменить в файле **C:\\EcrService\\Ecr.SelfHosting.exe.config** |error_3|

- Нажимаем правый кнопкой на этом файле, выбираем **Открыть с помощью** |error_4|

- Открываем этот файл в блокноте |error_5|

- Находим строку с **http://localhost:8095** и изменяем **8095** на какой-нибудь другой порт, например **8099** |error_6|

- Сохраняем файл и перезапускаем службу

.. ATTENTION::
    Не забудьте, если вы поменяли порт, то в настройках ассистента в Медеске тоже надо будет поменять хост на **http://Admin:1233@http://localhost:8099**

Ошибки при проверке кассы
'''''''''''''''''

**Ошибка.** -3 (Порт недоступен (System Error.  Code: 2.Не удается найти указанный файл))

**Решение.** Скорее всего вы либо выбрали неправильный COM порт или у вас не полностью установились драйвера для кассы. Попробуйте `Ручная установка USB драйверов кассы (только для касс АТОЛ)`_

**Ошибка.** -1 (Нет связи)

**Решение.** Тут либо касса не включена или кабель поврежден. 

Конфликт со службой Хеликса
'''''''''''''''''

Если клиент использует Хеликс для печати чеков, то скорее всего COM порт всегда занят их службой

.. ATTENTION::
    Для того, чтобы убедиться, что это так, стоит зайти в логи, как описано в `Логи службы`_. Если в логах есть ошибки вида **Порт занят**, то это значит, что служба Хеликса заняла порт

**Решение.** Единственный вариант пока, отключать **Службу печати чеков Хеликс** (неточное название) 


Дополнительно
--------------------------------------------

Логи службы 
'''''''''''''''''

Если при запуске или в ходе работы службы произошла ошибка, то стоит для начала зайти в каталог **C:\\EcrService\\logs**, открыть файл **ecr-service.log** и изучить логи |error_1|

Ручная установка USB драйверов кассы (только для касс АТОЛ) 
'''''''''''''''''

Иногда при установке драйверов не устанвливаются драйвера для эмуляции COM порта через USB. Для того чтобы понять установились ли они, вам надо:

- Зайти в **Панель управления -> Система -> Диспетчер устройств**

- Если есть неизвестные устройства значит драйвера не установились |advanced_1|

- Зайдите в контекстное меню и нажмите **Обновить драйвер** |advanced_2|

- Выберите **Выполнить поиск драйверов на этом компьютере** |advanced_3|

- Введите в место для поиска **C:\\Program Files\\ATOL\\Drivers8\\USB_Drivers** (либо **Program files(x86)** если система 64-битная) |advanced_4|

- Если выскочит предупреждение выберите **Все равно установить этот драйвер** |advanced_5|

- Дождитесь окончания установки

- Проделайте тоже самое для второго неизвестного устройства

- В итоге у вас в диспетчере должны появиться два устройства |advanced_6|


Проверка кассы через **Тест драйвер ККМ** 
'''''''''''''''''

- Зайдите в **Пуск -> Все программы -> АТОЛ -> Драйверы торгового оборудования v.8 -> Тесты -> Драйвер ККМ** |advanced_7|

- Нажмите **Настройка свойств** |advanced_8|

- Убедитесь что выбрана правильная модель и COM порт и нажмите **Проверка связи**. Должно выйти сообщение примерно как на скриншоте |advanced_9|

- Если есть ошибки проверьте в `Ошибки при проверке кассы`_


Настройка возможности отправки чеков в ОФД 
'''''''''''''''''

- Зайдите в **Пуск -> Все программы -> АТОЛ -> Драйверы торгового оборудования v.8 -> Управление драйверами** |advanced_10|

- Все должно быть выставлено как на скриншоте, кроме **Подключенные ККМ** |advanced_11|

- В **Подключенные ККМ** нужно выставить в COM-порт второй COM порт который имеет имя вроде **COM4: FPrintUSB1**, т.е заканчивается на FPrintUSB1

Открытие порта в брандмауэре Windows
'''''''''''''''''

- Зайдите в **Пуск -> Панель управления -> Брандмауэр Windows** 

- Нажмите слева **Дополнительные параметры** |advanced_12|

- Перейдите в раздел **Правила для входящих подключений** и нажмите справа **Создать правило** |advanced_13|

- Выберите **Для порта** и нажмите **Далее** |advanced_14|

- Выберите **Протокол TCP** и в **Определенные локальные порты** введите порт на котором запущена служба (по умолчанию это 8095) и нажмите **Далее** |advanced_15|

- Выберите **Разрешить подключение** и нажмите **Далее** |advanced_16|

- Нажмите **Далее** |advanced_17|

- Введите любое имя в поле **Имя** и нажмите **Готово** |advanced_18|


.. |ecr1| image:: _static/ecr_1.png
.. |ecr2| image:: _static/ecr_2.png
.. |ecr3| image:: _static/ecr_3.png
.. |ecr4| image:: _static/ecr_4.png
.. |ecr5| image:: _static/ecr_5.png
.. |ecr6| image:: _static/ecr_6.png
.. |ecr7| image:: _static/ecr_7.png
.. |ecr8| image:: _static/ecr_8.png
.. |ecr9| image:: _static/ecr_9.png

.. |atol1| image:: _static/atol_1.png
.. |atol2| image:: _static/atol_2.png
.. |atol3| image:: _static/atol_3.png
.. |atol4| image:: _static/atol_4.png
.. |atol5| image:: _static/atol_5.png
.. |atol6| image:: _static/atol_6.png

.. |ecr_install1| image:: _static/ecr_install_1.png
.. |ecr_install2| image:: _static/ecr_install_2.png
.. |ecr_install3| image:: _static/ecr_install_3.png
.. |ecr_install4| image:: _static/ecr_install_4.png
.. |ecr_install5| image:: _static/ecr_install_5.png

.. |error_1| image:: _static/error_1.png
.. |error_2| image:: _static/error_2.png
.. |error_3| image:: _static/error_3.png
.. |error_4| image:: _static/error_4.png
.. |error_5| image:: _static/error_5.png
.. |error_6| image:: _static/error_6.png

.. |advanced_1| image:: _static/advanced_1.png
.. |advanced_2| image:: _static/advanced_2.png
.. |advanced_3| image:: _static/advanced_3.png
.. |advanced_4| image:: _static/advanced_4.png
.. |advanced_5| image:: _static/advanced_5.png
.. |advanced_6| image:: _static/advanced_6.png
.. |advanced_7| image:: _static/advanced_7.png
.. |advanced_8| image:: _static/advanced_8.png
.. |advanced_9| image:: _static/advanced_9.png
.. |advanced_10| image:: _static/advanced_10.png
.. |advanced_11| image:: _static/advanced_11.png
.. |advanced_12| image:: _static/advanced_12.png
.. |advanced_13| image:: _static/advanced_13.png
.. |advanced_14| image:: _static/advanced_14.png
.. |advanced_15| image:: _static/advanced_15.png
.. |advanced_16| image:: _static/advanced_16.png
.. |advanced_17| image:: _static/advanced_17.png
.. |advanced_18| image:: _static/advanced_18.png